# ğŸ”— Status de IntegraÃ§Ã£o - Sistema Multi-Window

## âœ… Fase 2: IntegraÃ§Ã£o do Estado Global

### Arquivos Atualizados

#### 1. **App.vue** (Janela Principal)

```typescript
// âœ… ImportaÃ§Ãµes adicionadas
import {
  useGlobalState,
  registerWindow,
  isComponentInWindow,
} from "./core/state";
import WindowConfig from "./components/WindowConfig.vue";

// âœ… ID Ãºnico da janela
const mainWindowId = "main-" + Date.now();

// âœ… Estado global inicializado
const { state: globalState } = useGlobalState();

// âœ… Janela registrada no onMounted
onMounted(() => {
  const now = Date.now();
  registerWindow({
    id: mainWindowId,
    title: "Audio Visualizer - Main",
    role: "main",
    effects: ["gradient", "particles", "waveform"],
    layout: "grid",
    backgroundColor: "#000000",
    createdAt: now,
    lastActive: now,
  });

  // ... resto do cÃ³digo de registro de componentes
});
```

**Template:**

```vue
<template>
  <RouterView />

  <!-- âœ… WindowConfig adicionado -->
  <WindowConfig :window-id="mainWindowId" />

  <!-- Matrix Title -->
  <div class="matrix-title">...</div>

  <!-- Resto dos componentes... -->
</template>
```

#### 2. **VisualView.vue** (Janela SecundÃ¡ria)

```typescript
// âœ… ImportaÃ§Ãµes adicionadas
import { registerWindow } from "../core/state";
import WindowConfig from "../components/WindowConfig.vue";

// âœ… ID Ãºnico da janela
const visualWindowId = "visual-" + Date.now();

// âœ… Janela registrada no onMounted
onMounted(() => {
  const now = Date.now();
  registerWindow({
    id: visualWindowId,
    title: "Visual Window",
    role: "secondary",
    effects: ["gradient"], // Apenas gradient inicialmente
    layout: "fullscreen",
    backgroundColor: "#000000",
    createdAt: now,
    lastActive: now,
  });

  // ... resto do cÃ³digo
});
```

**Template:**

```vue
<template>
  <div class="visual-view">
    <!-- âœ… WindowConfig adicionado -->
    <WindowConfig :window-id="visualWindowId" />

    <!-- Visual info... -->
  </div>
</template>
```

---

## ğŸ¯ O Que JÃ¡ Funciona

### 1. **WindowConfig Component** âœ…

- **PosiÃ§Ã£o**: Canto superior direito (collapsible)
- **Funcionalidades**:
  - âš™ï¸ BotÃ£o para expandir/colapsar
  - âœï¸ EdiÃ§Ã£o do tÃ­tulo da janela
  - â˜‘ï¸ Toggle de efeitos visuais (gradient habilitado)
  - ğŸ“Š InformaÃ§Ãµes da janela (ID, role, contagem de componentes)

### 2. **Estado Global** âœ…

- **Singleton reativo** compartilhado entre todas as janelas
- **PersistÃªncia** automÃ¡tica no localStorage
- **SincronizaÃ§Ã£o** via BroadcastChannel
- **Action-based mutations** (Redux-like)

### 3. **Registro de Janelas** âœ…

- Main window: `'main-' + timestamp`
- Visual window: `'visual-' + timestamp`
- Cada janela tem configuraÃ§Ã£o independente

---

## ğŸ”„ O Que Falta Implementar

### 1. **RenderizaÃ§Ã£o Condicional de Efeitos**

**Objetivo**: Cada janela sÃ³ renderiza os efeitos marcados em `effects[]`

**Onde implementar**: `useSpectralVisualEffect` composable

```typescript
// Em App.vue e VisualView.vue
const windowConfig = computed(() =>
    globalState.windows[currentWindowId]
)

// SÃ³ inicializa efeito se estiver habilitado
if (windowConfig.value?.effects.includes('gradient')) {
    useSpectralVisualEffect({ ... })
}
```

### 2. **Sistema de Drag & Drop entre Janelas**

**Objetivo**: Arrastar componentes de uma janela para outra

**Arquivos envolvidos**:

- `/src/core/drag/useCrossWindowDrag.ts` (jÃ¡ criado, precisa refinamento)
- `/src/directives/draggable.ts` (precisa integraÃ§Ã£o)

**Refinamentos necessÃ¡rios**:

```typescript
// Detectar quando mouse sai da janela
function handleMouseLeave(e: MouseEvent) {
  // TODO: Broadcast posiÃ§Ã£o global (window.screenX/Y)
  // TODO: Outras janelas detectam se mouse estÃ¡ sobre elas
}

// Ao soltar (drop), transferir propriedade
function handleMouseUp(e: MouseEvent) {
  const targetWindowId = detectWindowUnderMouse();
  moveComponent(componentId, targetWindowId, newTransform);
}
```

### 3. **Filtro de Componentes por Janela**

**Objetivo**: Cada componente sÃ³ aparece na janela dona (`windowId`)

**Onde implementar**: Template do App.vue

```vue
<!-- Antes (hardcoded v-show) -->
<SoundControl v-show="showSoundControl" ... />

<!-- Depois (baseado em windowId) -->
<SoundControl
  v-if="isComponentInWindow('sound-control', mainWindowId)"
  v-show="showSoundControl"
  ...
/>
```

### 4. **Refatorar Draggable Directive**

**Objetivo**: Usar global state em vez de localStorage local

**Arquivo**: `/src/directives/draggable.ts`

```typescript
// Antes
function savePosition(id: string, position: Position) {
  localStorage.setItem(`component-${id}`, JSON.stringify(position));
}

// Depois
import { moveComponent } from "@/core/state";

function savePosition(id: string, position: Position) {
  const currentWindowId = getCurrentWindowId();
  moveComponent(id, currentWindowId, {
    x: position.x,
    y: position.y,
  });
}
```

### 5. **SincronizaÃ§Ã£o de Theme/RGB/Chameleon**

**Objetivo**: MudanÃ§as de tema propagam para todas as janelas

**Onde implementar**:

- `useRgbMode.ts`
- `useChameleonMode.ts`
- `ThemeSelector.vue`

```typescript
// Adicionar dispatch de aÃ§Ãµes globais
function setTheme(theme: string) {
  dispatch({
    type: "THEME_CHANGED",
    payload: { theme },
  });
}
```

### 6. **Views Adicionais**

- **ControlsView** (`/controls`): Apenas controles, sem visuais
- **GridView** (`/grid`): Layout em grid com mÃºltiplos componentes

---

## ğŸ“‹ PrÃ³ximos Passos Recomendados

### **Prioridade Alta** ğŸ”´

1. **RenderizaÃ§Ã£o Condicional de Efeitos**

   - Modificar inicializaÃ§Ã£o do `useSpectralVisualEffect`
   - Adicionar checks para `windowConfig.effects.includes('gradient')`
   - Testar toggle de gradient on/off

2. **Filtro de Componentes por Janela**
   - Adicionar `v-if="isComponentInWindow(...)"` nos componentes
   - Implementar lÃ³gica de ownership
   - Componentes sÃ³ aparecem na janela correta

### **Prioridade MÃ©dia** ğŸŸ¡

3. **Refinar Cross-Window Drag**

   - Melhorar detecÃ§Ã£o de mouse entre janelas
   - Implementar drop zone visual
   - Testar transferÃªncia de propriedade

4. **Refatorar Draggable Directive**
   - Integrar com global state
   - Remover localStorage local
   - Usar `moveComponent()` do state

### **Prioridade Baixa** ğŸŸ¢

5. **ControlsView & GridView**

   - Criar novas rotas
   - Adicionar WindowConfig em cada uma
   - Layouts customizados

6. **SincronizaÃ§Ã£o de Theme**
   - Broadcast de mudanÃ§as de tema
   - Aplicar em todas as janelas
   - PersistÃªncia global

---

## ğŸ§ª Como Testar Agora

```bash
# 1. Inicie o dev server
npm run dev

# 2. Abra a janela principal
# http://localhost:5173

# 3. No MainControl, clique em "Open Visual Window"
# Nova janela abre em: http://localhost:5173/#/visual

# 4. Em cada janela, clique no âš™ï¸ (canto superior direito)

# 5. Teste os controles:
# - Edite o tÃ­tulo da janela (Enter ou blur para salvar)
# - Toggle "Gradient Effect" on/off
# - Veja as informaÃ§Ãµes da janela
```

### **Resultado Esperado** âœ…

- WindowConfig aparece em ambas as janelas
- TÃ­tulos editÃ¡veis e sincronizados
- Checkbox de gradient funcional (lÃ³gica ainda nÃ£o conectada)
- Estado persiste no localStorage

### **Resultado Atual** âš ï¸

- WindowConfig UI funciona
- Estado global registra janelas
- **MAS**: Efeitos ainda nÃ£o respeitam configuraÃ§Ã£o
- **MAS**: Componentes nÃ£o filtram por windowId
- **MAS**: Drag & drop nÃ£o transfere entre janelas

---

## ğŸ“š Arquitetura Atual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GLOBAL STATE                         â”‚
â”‚  (singleton reativo compartilhado)                      â”‚
â”‚                                                         â”‚
â”‚  windows: {                                             â”‚
â”‚    'main-123': {                                        â”‚
â”‚      title: 'Audio Visualizer - Main',                 â”‚
â”‚      effects: ['gradient', 'particles', 'waveform']    â”‚
â”‚    },                                                   â”‚
â”‚    'visual-456': {                                      â”‚
â”‚      title: 'Visual Window',                           â”‚
â”‚      effects: ['gradient']                             â”‚
â”‚    }                                                    â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â”‚  components: {                                          â”‚
â”‚    'main-control': {                                    â”‚
â”‚      windowId: 'main-123',  â† ownership                â”‚
â”‚      transform: { x: 100, y: 200 }                     â”‚
â”‚    },                                                   â”‚
â”‚    'sound-control': {                                   â”‚
â”‚      windowId: 'main-123'                              â”‚
â”‚    }                                                    â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                   BroadcastChannel
                 'GLOBAL_STATE_ACTION'
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Window  â”‚                      â”‚ Visual Window â”‚
â”‚  (main-123)   â”‚                      â”‚ (visual-456)  â”‚
â”‚               â”‚                      â”‚               â”‚
â”‚  âš™ï¸ WindowConfig                     â”‚  âš™ï¸ WindowConfigâ”‚
â”‚  ğŸ“Š All Components                   â”‚  ğŸ¨ Gradient Onlyâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ Conceitos-Chave

### **Component Ownership**

- Cada componente tem `windowId` (pode ser `null`)
- `windowId: 'main-123'` â†’ componente pertence Ã  janela main
- `windowId: null` â†’ componente nÃ£o visÃ­vel
- Ao arrastar entre janelas, `windowId` muda

### **Per-Window Effects**

- Cada janela tem `effects: VisualEffect[]`
- Janela sÃ³ renderiza efeitos em sua lista
- Main: `['gradient', 'particles', 'waveform']`
- Visual: `['gradient']` (apenas)

### **Action-Based Sync**

- Toda mutaÃ§Ã£o = action: `{ type: 'WINDOW_UPDATED', payload: {...} }`
- Action aplicada localmente + broadcast
- Outras janelas recebem e aplicam
- Estilo Redux, mas Vue-native

---

**Status Geral**: ğŸŸ¡ **60% Completo**

- âœ… Core state management
- âœ… Window registration
- âœ… WindowConfig UI
- âš ï¸ Effect rendering (pending)
- âš ï¸ Component ownership (pending)
- âš ï¸ Cross-window drag (needs refinement)
